#!/bin/bash
# Source: https://gitlab.com/gitlab-org/charts/gitlab/-/issues/3387#note_1029971225

set -eu

# Setup environment
export NAMESPACE=${NAMESPACE:-gitlab}
export RELEASE=${RELEASE:-gitlab}
export CREATE=${CREATE:-no}
export CERT_SANS=${CERT_SANS:-"*.${NAMESPACE}.svc,${RELEASE}-metrics.${NAMESPACE}.svc,*.${RELEASE}-gitaly.${NAMESPACE}.svc"}
export CN=${CN:-"${RELEASE}.${NAMESPACE}.internal"}

# Setup working directory
mkdir -p certs
cd certs

# Generate default CA config
cfssl print-defaults config > ca-config.json

# Generate a CA
echo '{"CN":"'${CN}.ca'","key":{"algo":"ecdsa","size":256}}' | \
  cfssl gencert -initca - | \
  cfssljson -bare ca -

# Generate certificate
echo '{"CN":"'${CN}'","key":{"algo":"ecdsa","size":256}}' | \
  cfssl gencert -config=ca-config.json -ca=ca.pem -ca-key=ca-key.pem -profile www -hostname="${CERT_SANS}" - |\
  cfssljson -bare ${RELEASE}-services

echo "generated in ./certs/"

# Load certificates into K8s
if [ "${CREATE}" = "yes" ]; then
  kubectl -n ${NAMESPACE} create secret tls ${RELEASE}-tls --cert=${RELEASE}-services.pem --key=${RELEASE}-services-key.pem

  # As a Secret
  kubectl -n ${NAMESPACE} create secret generic ${RELEASE}-tls-ca --from-file=ca.crt=ca.pem

  # Or, as a ConfigMap
  kubectl -n ${NAMESPACE} create configmap ${RELEASE}-tls-ca --from-file=ca.pem
else
  echo 'skipping Secret creation, set CREATE=yes to enable'
fi

# Generate example values file
cat <<EOF > custom-certs.yaml
global:
  certificates:
    customCAs:
      - secret: gitlab-tls-ca
  hosts:
    registry:
      protocol: https
gitlab:
  webservice:
    workhorse:
      tls:
        enabled: true
        secretName: gitlab-tls # type: kubernetes.io/tls
        caSecretName: ${NAMESPACE}/gitlab-tls-ca
registry:
  tls:
    enabled: true
    secretName: gitlab-tls
    caSecretName: ${NAMESPACE}/gitlab-tls-ca
EOF

# Alternative from Robert Marshall:
#
# https://github.com/smallstep/cli/releases
# ./step certificate create TLD gitlab.MY.TLD.crt gitlab.MY.TLD.key \
#   -kty RSA -size 4096 \
#   --profile self-signed --subtle \
#   --san gitaly.gitlab.MY.TLD \
#   --san redis01.gitlab.MY.TLD \
#   --san redis02.gitlab.MY.TLD \
#   --san redis03.gitlab.MY.TLD \
#   --san postgres.gitlab.MY.TLD \
#   --san gitlab.gitlab.MY.TLD \
#   --san mattermost.gitlab.MY.TLD \
#   --no-password --insecure
